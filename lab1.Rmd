---
title: "Lab 1"
output: html_document
date: "2026-01-16"
author: "Mario Fernando Rocha 23501, Luis Pedro Lira 23669,Juan Francisco Martínez 23617"
```{r}

```

---
```{r}

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r paquetes}
library(nortest)
library(ggplot2)
library(dplyr)
library(cluster) #Para calcular la silueta
library(e1071)#para cmeans
library(mclust) #mixtures of gaussians
library(fpc) #para hacer el plotcluster
library(NbClust) #Para determinar el número de clusters óptimo
library(factoextra) #Para hacer gráficos bonitos de clustering
library(hopkins) #Para revisar si vale la pena hacer agrupamiento
library(GGally) #Para hacer el conjunto de graficos
library(FeatureImpCluster) #Para revisar la importancia de las variables en los grupos.
library(pheatmap) #Para hacer mapa de calor
library(scales)  #Para las escalas de la gráficas
library(lubridate)#para las fechas

```

#  Análisis exploratorio de Datos

## Carros

```{r carga_datos}
movies <- read.csv("movies_2026.csv")
head(movies)

```
### Pregunta 1:  Exploración rápida de los Datos

#Dimensiones
```{r}
nrow(movies) #númdro de Filas 
ncol(movies) #número de Columnas
dim(movies) #dimensión del Data Set


names(movies) # Nombres de columna


str(movies) # Estructura (tipos de datos)


summary(movies) # Resumen rápido (por defecto)
```
#Datos Faltantes y Duplicados
```{r}
# Cantidad de NA por columna
na_conteo <- colSums(is.na(movies))

# Porcentaje de NA por columna
na_porcentaje <- round(colMeans(is.na(movies)) * 100, 2)

# Tabla resumen de faltantes
faltantes <- data.frame(
  variable = names(movies),
  na = as.vector(na_conteo),
  na_pct = as.vector(na_porcentaje)
)


head(faltantes, 15)  # Top 15 columnas con más NA

# Duplicados (filas repetidas)
sum(duplicated(movies))

```
#Resumen de variables Numéricas
```{r}
# Detectar columnas numéricas
num_cols <- sapply(movies, is.numeric)
datos_num <- movies[, num_cols]

# Resumen estadístico simple por variable numérica
res_num <- data.frame(
  variable = names(datos_num),
  media = sapply(datos_num, mean, na.rm = TRUE),
  mediana = sapply(datos_num, median, na.rm = TRUE),
  sd = sapply(datos_num, sd, na.rm = TRUE),
  min = sapply(datos_num, min, na.rm = TRUE),
  max = sapply(datos_num, max, na.rm = TRUE)
)

head(res_num)

```
#variables Categóricas
```{r}
cat_cols <- sapply(movies, is.character) | sapply(movies, is.factor)
names(movies[, cat_cols])
```
### Pregunta número 2
```{r}
variable_type <- data.frame(
  Variable = names(movies),
  Tipo = c(
    "Cuantitativa discreta", "Cuantitativa continua", "Cuantitativa continua",
    "Cuantitativa continua", "Cualitativa nominal", "Cualitativa nominal",
    "Cualitativa nominal", "Cualitativa nominal", "Cualitativa nominal",
    "Cualitativa nominal", "Cuantitativa continua", "Cualitativa nominal",
    "Cuantitativa discreta", "Cualitativa nominal", "Cuantitativa discreta",
    "Cualitativa nominal", "Cualitativa nominal", "Cuantitativa discreta",
    "Cualitativa nominal", "Cuantitativa discreta", "Cuantitativa continua",
    "Cualitativa nominal", "Cuantitativa continua", "Cualitativa nominal",
    "Cuantitativa discreta", "Cuantitativa discreta", "Cuantitativa discreta",
    "Cuantitativa discreta"
  )
)

variable_type
```
###Pregunta número 3

## Separar las variables
```{r}
vars_cuant <- variable_type$Variable[grepl("Cuantitativa", variable_type$Tipo)]
vars_cual  <- variable_type$Variable[grepl("Cualitativa", variable_type$Tipo)]

vars_cuant
vars_cual
```
##normalizar
```{r}

set.seed(123)

normalidad_list <- lapply(vars_cuant, function(v){
  x <- movies[[v]]
  x <- x[!is.na(x)]
  x <- x[is.finite(x)]   # por si hay Inf/NaN

  n <- length(x)

  if(n < 3){
    return(data.frame(
      Variable = v,
      n = n,
      muestra = n,
      p_value = NA,
      decision = "No aplica (n<3)"
    ))
  }

  m <- min(n, 5000)
  xs <- sample(x, m)

  p <- shapiro.test(xs)$p.value
  decision <- ifelse(p < 0.05, "Rechaza normalidad", "No rechaza normalidad")

  data.frame(
    Variable = v,
    n = n,
    muestra = m,
    p_value = p,
    decision = decision
  )
})

normalidad <- bind_rows(normalidad_list) %>%
  arrange(p_value)

normalidad
```
##Pregunta 4

###Top 10 películas con más presupuesto
```{r}
top10_budget <- movies %>%
  filter(!is.na(budget)) %>%
  arrange(desc(budget)) %>%
  select(title, budget, revenue, releaseYear) %>%
  head(10)

top10_budget
```
###Top 10 películas con más ingresos
```{r}
top10_revenue <- movies %>%
  filter(!is.na(revenue)) %>%
  arrange(desc(revenue)) %>%
  select(title, revenue, budget, releaseYear) %>%
  head(10)

top10_revenue
```
### Película con más votos
```{r}
pelicula_mas_votos <- movies %>%
  filter(!is.na(voteCount)) %>%
  arrange(desc(voteCount)) %>%
  select(title, voteCount, voteAvg, revenue, budget, releaseYear) %>%
  head(1)

pelicula_mas_votos
```
### Película con menos votos
```{r}
peliculas_0_votos <- movies %>%
  filter(!is.na(voteCount), voteCount == 0) %>%
  select(title, voteCount, voteAvg, releaseYear)

peliculas_0_votos

min_votos_pos <- movies %>%
  filter(!is.na(voteCount), voteCount > 0) %>%
  summarise(min_voteCount = min(voteCount)) %>%
  pull(min_voteCount)

peliculas_menos_votos_con_voto <- movies %>%
  filter(!is.na(voteCount), voteCount == min_votos_pos) %>%
  select(title, voteCount, voteAvg, releaseYear)

min_votos_pos
peliculas_menos_votos_con_voto
```
###Películas por año
```{r}
peliculas_por_anio <- movies %>%
  filter(!is.na(releaseYear)) %>%
  mutate(releaseYear = as.integer(releaseYear)) %>%
  count(releaseYear, name = "cantidad") %>%
  arrange(releaseYear)

anio_mas <- peliculas_por_anio %>%
  slice_max(cantidad, n = 1, with_ties = FALSE)

ggplot(peliculas_por_anio, aes(x = releaseYear, y = cantidad)) +
  geom_col(width = 0.85) +
  geom_text(
    data = anio_mas,
    aes(label = paste0("Máximo: ", releaseYear, "\n(", comma(cantidad), ")")),
    vjust = -0.4,
    size = 3.5
  ) +
  scale_x_continuous(
    breaks = seq(min(peliculas_por_anio$releaseYear), max(peliculas_por_anio$releaseYear), by = 5)
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Cantidad de películas por año",
    x = "Año",
    y = "Cantidad de películas"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold")
  )
```
###Género de películas
```{r}
movies2 <- movies %>%
  mutate(
    main_genre = ifelse(is.na(genres) | genres == "", "Sin género", sub("\\|.*", "", genres)),
    
    release_dt = suppressWarnings(ymd(releaseDate)),
    
    release_dt = ifelse(is.na(release_dt) & !is.na(releaseYear),
                        as.Date(paste0(releaseYear, "-12-31")),
                        release_dt) %>% as.Date()
  )


```
####top 20 películas más recientes
```{r}
top20_recientes <- movies2 %>%
  filter(!is.na(release_dt)) %>%
  arrange(desc(release_dt)) %>%
  select(title, releaseYear, releaseDate, main_genre, runtime) %>%
  head(20)

top20_recientes
```
####Género predominante
```{r}
freq_genero <- movies2 %>%
  count(main_genre, sort = TRUE) %>%
  mutate(porcentaje = round(100*n/sum(n), 2))

freq_genero


```
####Género predominante
```{r}
genero_predominante <- freq_genero %>% head(1)
genero_predominante
```
####Gráfico de top 15 géneros
```{r}
freq_top15 <- freq_genero %>% head(15)

ggplot(freq_top15, aes(x = reorder(main_genre, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Top 15 géneros más frecuentes",
    x = "Género principal",
    y = "Cantidad de películas"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )
```
####Películas más largas 
```{r}
top20_largas <- movies2 %>%
  filter(!is.na(runtime), runtime > 0) %>%
  arrange(desc(runtime)) %>%
  select(title, runtime, releaseYear, main_genre) %>%
  head(20)

top20_largas
```
####Género de las películas más largas
```{r}
top50_largas <- movies2 %>%
  filter(!is.na(runtime), runtime > 0) %>%
  arrange(desc(runtime)) %>%
  head(50)

freq_genero_largas <- top50_largas %>%
  count(main_genre, sort = TRUE) %>%
  mutate(porcentaje = round(100*n/sum(n), 2))

freq_genero_largas
```
####Género predominante en las más largas
```{r}
genero_top_largas <- freq_genero_largas %>% head(1)
genero_top_largas
```
####Gráfico de los géneros predominantes en las películas más largas
```{r}
ggplot(freq_genero_largas, aes(x = reorder(main_genre, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Género principal en las 50 películas más largas",
    x = "Género principal",
    y = "Cantidad"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )
```
####Género con más ganancias
```{r}
movies_gan <- movies %>%
  mutate(
    main_genre = ifelse(is.na(genres) | genres == "", "Sin género", sub("\\|.*", "", genres)),
    ganancia = revenue - budget
  ) %>%
  filter(!is.na(budget), !is.na(revenue), budget > 0, revenue > 0)

# Resumen por género
gan_por_genero <- movies_gan %>%
  group_by(main_genre) %>%
  summarise(
    peliculas = n(),
    ganancia_total = sum(ganancia, na.rm = TRUE),
    ganancia_promedio = mean(ganancia, na.rm = TRUE),
    ganancia_mediana = median(ganancia, na.rm = TRUE)
  ) %>%
  arrange(desc(ganancia_promedio))

gan_por_genero
```
```{r}
genero_mayor_promedio <- gan_por_genero %>% head(1)
genero_mayor_promedio
```
```{r}
genero_mayor_total <- gan_por_genero %>%
  arrange(desc(ganancia_total)) %>%
  head(1)

genero_mayor_total
```
```{r}
library(ggplot2)

top10_gan <- gan_por_genero %>% head(10)

ggplot(top10_gan, aes(x = reorder(main_genre, ganancia_promedio), y = ganancia_promedio)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Top 10 géneros por ganancia promedio (revenue - budget)",
    x = "Género principal",
    y = "Ganancia promedio"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )
```
#### Análisis de actores
```{r}
##limpiar datos
df_actores_ing <- movies %>%
  filter(!is.na(actorsAmount), !is.na(revenue)) %>%
  filter(actorsAmount > 0, revenue > 0)

summary(df_actores_ing$actorsAmount)
summary(df_actores_ing$revenue)
```
```{r}
##gráfico de relación entre cantidad de actores e ingresos
ggplot(df_actores_ing, aes(x = actorsAmount, y = revenue)) +
  geom_point(alpha = 0.3) +
  scale_y_log10() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    title = "Relación entre cantidad de actores e ingresos",
    subtitle = "Eje Y en escala log10 (revenue)",
    x = "Cantidad de actores (actorsAmount)",
    y = "Ingresos (revenue)"
  ) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"))
```


```{r}
##Actores por año
df_actores_anio <- movies %>%
  filter(!is.na(releaseYear), !is.na(actorsAmount)) %>%
  mutate(releaseYear = as.integer(releaseYear)) %>%
  filter(actorsAmount > 0)

actores_por_anio <- df_actores_anio %>%
  group_by(releaseYear) %>%
  summarise(
    peliculas = n(),
    promedio_actores = mean(actorsAmount, na.rm = TRUE),
    mediana_actores = median(actorsAmount, na.rm = TRUE)
  ) %>%
  arrange(releaseYear)

actores_por_anio
```
```{r}
##Gráfico de tendencia
ggplot(actores_por_anio, aes(x = releaseYear, y = mediana_actores)) +
  geom_line() +
  geom_point(size = 1) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    title = "¿Han aumentado los actores en películas con el tiempo?",
    subtitle = "Mediana de actorsAmount por año + tendencia lineal",
    x = "Año",
    y = "Mediana de actores"
  ) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"))
```
```{r}
##Comparación de los últimos años con años recientes
max_anio <- max(df_actores_anio$releaseYear, na.rm = TRUE)
corte <- max_anio - 5

comparacion <- df_actores_anio %>%
  mutate(periodo = ifelse(releaseYear >= corte, "Últimos 5 años", "Años anteriores")) %>%
  group_by(periodo) %>%
  summarise(
    peliculas = n(),
    promedio_actores = mean(actorsAmount, na.rm = TRUE),
    mediana_actores = median(actorsAmount, na.rm = TRUE)
  )

corte
comparacion
```
###Cantidad de hombres y mujeres en las películas
```{r}
##preparar datos
df_cast <- movies %>%
  filter(!is.na(castWomenAmount), !is.na(castMenAmount)) %>%
  mutate(
    cast_total = castWomenAmount + castMenAmount,
    pct_women = ifelse(cast_total > 0, castWomenAmount / cast_total, NA)
  ) %>%
  filter(!is.na(pct_women), cast_total > 0)

summary(df_cast$castWomenAmount)
summary(df_cast$castMenAmount)
summary(df_cast$pct_women)
```
```{r}
# Popularidad vs cantidad de mujeres/hombres y proporción
cor_pop_women <- cor.test(df_cast$castWomenAmount, df_cast$popularity, method = "spearman")
cor_pop_men   <- cor.test(df_cast$castMenAmount,   df_cast$popularity, method = "spearman")
cor_pop_pctw  <- cor.test(df_cast$pct_women,       df_cast$popularity, method = "spearman")

cor_pop_women
cor_pop_men
cor_pop_pctw
```
```{r}
ggplot(df_cast, aes(x = pct_women, y = popularity)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    title = "Proporción de mujeres en el cast vs popularidad",
    x = "Proporción de mujeres (castWomenAmount / total)",
    y = "Popularidad"
  ) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"))
```
```{r}
df_cast_rev <- df_cast %>%
  filter(!is.na(revenue), revenue > 0)

summary(df_cast_rev$revenue)
```
```{r}
cor_rev_women <- cor.test(df_cast_rev$castWomenAmount, df_cast_rev$revenue, method = "spearman")
cor_rev_men   <- cor.test(df_cast_rev$castMenAmount,   df_cast_rev$revenue, method = "spearman")
cor_rev_pctw  <- cor.test(df_cast_rev$pct_women,       df_cast_rev$revenue, method = "spearman")

cor_rev_women
cor_rev_men
cor_rev_pctw
```
####20 mejores actores según las películas
```{r}
top20_mejor_calif <- movies %>%
  filter(!is.na(voteAvg), !is.na(voteCount)) %>%
  filter(voteCount >= 100) %>%   # puedes cambiar 100 por 50 o 200
  arrange(desc(voteAvg), desc(voteCount)) %>%
  select(title, director, voteAvg, voteCount, releaseYear) %>%
  head(20)

top20_mejor_calif
```
```{r}
directores_top20 <- top20_mejor_calif %>%
  distinct(director)

directores_top20
```
####Correlación de presupuestos con ingresos
```{r}
##limpiar datos
df_br <- movies %>%
  filter(!is.na(budget), !is.na(revenue)) %>%
  filter(budget > 0, revenue > 0)

summary(df_br$budget)
summary(df_br$revenue)
```
```{r}
##histograma
ggplot(df_br, aes(x = budget)) +
  geom_histogram(bins = 30) +
  labs(title = "Histograma de Presupuesto (budget)", x = "Budget", y = "Frecuencia") +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"))
```
```{r}
ggplot(df_br, aes(x = revenue)) +
  geom_histogram(bins = 30) +
  labs(title = "Histograma de Ingresos (revenue)", x = "Revenue", y = "Frecuencia") +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"))
```
```{r}
ggplot(df_br, aes(x = log10(revenue))) +
  geom_histogram(bins = 30) +
  labs(title = "Histograma de log10(Ingresos)", x = "log10(Revenue)", y = "Frecuencia") +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"))
```
```{r}
ggplot(df_br, aes(x = budget, y = revenue)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    title = "Presupuesto vs Ingresos (escala normal)",
    x = "Budget",
    y = "Revenue"
  ) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"))
```
####Meses de lanzamiento con ingresos
```{r}
# Preparar datos con mes
df_mes <- movies %>%
  mutate(release_dt = suppressWarnings(ymd(releaseDate))) %>%
  filter(!is.na(release_dt), !is.na(revenue), revenue > 0) %>%
  mutate(
    mes_num = month(release_dt),
    mes = factor(month(release_dt, label = TRUE, abbr = TRUE),
                 levels = month(1:12, label = TRUE, abbr = TRUE))
  )

table(df_mes$mes)
```
```{r}
##resumen de mes
resumen_mes <- df_mes %>%
  group_by(mes) %>%
  summarise(
    peliculas = n(),
    revenue_mediana = median(revenue, na.rm = TRUE),
    revenue_promedio = mean(revenue, na.rm = TRUE)
  ) %>%
  arrange(desc(revenue_mediana))

resumen_mes
```
```{r}
ggplot(df_mes, aes(x = mes, y = revenue)) +
  geom_boxplot(outlier.alpha = 0.2) +
  scale_y_log10() +
  labs(
    title = "Ingresos por mes de lanzamiento",
    subtitle = "Boxplot con eje Y en escala log10 (revenue)",
    x = "Mes",
    y = "Ingresos (revenue)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold")
  )
```
```{r}
mes_mejor <- resumen_mes %>% head(1)
mes_mejor
```
```{r}
kruskal.test(revenue ~ mes, data = df_mes)

```












## 5. Análisis Exploratorio Adicional
En esta sección se plantean seis preguntas adicionales con el objetivo de explorar patrones
complementarios en el conjunto de datos, sin repetir los análisis realizados en los incisos
anteriores.

```{r}
movies_clean <- movies %>%
  filter(
    !is.na(revenue),
    !is.na(popularity),
    !is.na(runtime),
    !is.na(productionCountriesAmount),
    !is.na(genresAmount),
    !is.na(productionCoAmount),
    !is.na(castWomenAmount),
    !is.na(castMenAmount),
    !is.na(originalLanguage),
    !is.na(releaseYear)
  )
```


### 5.1 ¿Existe diferencia en los ingresos según la cantidad de países de producción?
```{r}
ggplot(movies_clean, aes(x = factor(productionCountriesAmount), y = revenue)) +
  geom_boxplot() +
  labs(
    x = "Cantidad de países de producción",
    y = "Ingresos",
    title = "Ingresos según cantidad de países de producción"
  ) +
  theme_minimal()
```

### 5.2 ¿La cantidad de géneros influye en la popularidad y calificación de las películas?
```{r}
ggplot(movies_clean, aes(x = genresAmount, y = popularity)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    x = "Cantidad de géneros",
    y = "Popularidad",
    title = "Relación entre cantidad de géneros y popularidad"
  ) +
  theme_minimal()
```
### 5.3 ¿Cómo ha cambiado la duración promedio de las películas a lo largo del tiempo?

```{r}
runtime_year <- movies_clean %>%
  group_by(releaseYear) %>%
  summarise(runtime_promedio = mean(runtime))

ggplot(runtime_year, aes(x = releaseYear, y = runtime_promedio)) +
  geom_line() +
  geom_point() +
  labs(
    x = "Año de lanzamiento",
    y = "Duración promedio (minutos)",
    title = "Evolución de la duración promedio de las películas"
  ) +
  theme_minimal()
```

### 5.4 ¿Las películas con más compañías productoras generan mayores ingresos?
```{r}
ggplot(movies_clean, aes(x = factor(productionCoAmount), y = revenue)) +
  geom_boxplot() +
  labs(
    x = "Cantidad de compañías productoras",
    y = "Ingresos",
    title = "Ingresos según número de compañías productoras"
  ) +
  theme_minimal()
```
### 5.5 ¿Existen diferencias en la popularidad de las películas según su idioma original?
En este análisis se consideran únicamente los idiomas más frecuentes en el conjunto de datos,
con el fin de evitar sesgos causados por idiomas con muy pocas observaciones.

```{r}
# Seleccionar los 5 idiomas más frecuentes
top_languages <- movies_clean %>%
  group_by(originalLanguage) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  slice_head(n = 5)
```

```{r}
# Filtrar solo películas en esos idiomas
movies_lang <- movies_clean %>%
  filter(originalLanguage %in% top_languages$originalLanguage)
```

```{r}
# Calcular popularidad promedio por idioma
pop_lang <- movies_lang %>%
  group_by(originalLanguage) %>%
  summarise(popularidad_promedio = mean(popularity))
```

```{r}
# Gráfico de barras
ggplot(pop_lang, aes(
  x = reorder(originalLanguage, -popularidad_promedio),
  y = popularidad_promedio
)) +
  geom_col() +
  labs(
    x = "Idioma original",
    y = "Popularidad promedio",
    title = "Popularidad promedio según idioma original"
  ) +
  theme_minimal()
```
### 5.6 ¿El balance de género en el elenco influye en la popularidad de las películas?
```{r}
movies_gender <- movies_clean %>%
  mutate(ratio_genero = castWomenAmount / castMenAmount) %>%
  filter(is.finite(ratio_genero))
```

```{r}
ggplot(movies_gender, aes(x = ratio_genero, y = popularity)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    x = "Ratio mujeres / hombres en el elenco",
    y = "Popularidad",
    title = "Relación entre balance de género y popularidad"
  ) +
  theme_minimal()
```
